<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙固件升级工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #7f8c8d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(44, 62, 80, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 2px solid var(--primary);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(30, 40, 60, 0.7);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--primary);
            color: #fff;
            display: flex;
            align-items: center;
        }
        
        .panel-title i {
            margin-right: 10px;
            font-size: 1.3em;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }
        
        .file-input-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .file-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .file-input:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .file-name {
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--primary);
            text-align: center;
        }
        
        .progress-container {
            margin: 25px 0;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #fff;
        }
        
        .progress-bar {
            height: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #1abc9c);
            border-radius: 12px;
            width: 0%;
            transition: width 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .status-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 1rem;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column-reverse;
        }
        
        .status-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #fff;
            display: flex;
            align-items: flex-start;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-item i {
            margin-right: 10px;
            min-width: 20px;
        }
        
        .status-item.success {
            color: var(--success);
        }
        
        .status-item.error {
            color: var(--danger);
        }
        
        .status-item.info {
            color: var(--primary);
        }
        
        .status-item.warning {
            color: var(--warning);
        }
        
        .uuid-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
            word-break: break-all;
            font-family: monospace;
            line-height: 1.8;
        }
        
        .uuid-title {
            color: #bbb;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .uuid-value {
            color: #fff;
            font-weight: bold;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            background: var(--danger);
        }
        
        .status-indicator.connected {
            background: var(--success);
        }
        
        .instructions {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .compatibility-warning {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-bluetooth-b"></i> 蓝牙固件升级工具</h1>
            <p class="subtitle">基于Web Bluetooth API的OTA升级解决方案 - 支持ESP32和其他BLE设备</p>
        </header>
        
        <div class="main id="mainContent">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-microchip"></i> 设备控制</h2>
                
                <div class="uuid-display">
                    <div class="uuid-title">OTA服务UUID</div>
                    <div class="uuid-value">1D14D6EE-FD63-4FA1-BFA4-8F47B42119F0</div>
                </div>
                
                <div class="uuid-display">
                    <div class="uuid-title">控制特征UUID</div>
                    <div class="uuid-value">F7BF3564-FB6D-4E53-88A4-5E37E0326063</div>
                </div>
                
                <div class="uuid-display">
                    <div class="uuid-title">数据特征UUID</div>
                    <div class="uuid-value">984227F3-34FC-4045-A5D0-2C581F81A153</div>
                </div>
                
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="connectionStatusText">未连接设备</span>
                </div>
                
                <div class="btn-group">
                    <button id="connectBtn" class="btn"><i class="fas fa-link"></i>连接蓝牙设备</button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled><i class="fas fa-unlink"></i>断开连接</button>
                </div>
                
                <div class="file-input-container">
                    <div class="file-input" id="fileInput">
                        <i class="fas fa-file-upload"></i> 点击选择固件文件 (.bin)
                    </div>
                    <div class="file-name" id="fileName">未选择文件</div>
                    <input type="file" id="firmwareFile" accept=".bin" hidden>
                </div>
                
                <div class="progress-container">
                    <div class="progress-text">
                        <span>传输进度</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="startBtn" class="btn btn-success" disabled><i class="fas fa-play"></i>开始升级</button>
                    <button id="stopBtn" class="btn btn-warning" disabled><i class="fas fa-stop"></i>结束升级</button>
                </div>
                
                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> 使用说明</h3>
                    <ol>
                        <li>点击"连接蓝牙设备"按钮配对设备</li>
                        <li>选择固件(.bin)文件</li>
                        <li>点击"开始升级"传输固件数据</li>
                        <li>传输完成后会自动发送结束命令</li>
                        <li>设备将重启并应用新固件</li>
                    </ol>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-tasks"></i> 升级状态</h2>
                
                <div class="status-box" id="statusBox">
                    <div class="status-item info"><i class="fas fa-info-circle"></i> 准备就绪，请连接设备并选择固件文件</div>
                    <div class="status-item"><i class="fas fa-code"></i> OTA服务UUID: 1D14D6EE-FD63-4FA1-BFA4-8F47B42119F0</div>
                    <div class="status-item"><i class="fas fa-code"></i> 控制特征UUID: F7BF3564-FB6D-4E53-88A4-5E37E0326063</div>
                    <div class="status-item"><i class="fas fa-code"></i> 数据特征UUID: 984227F3-34FC-4045-A5D0-2C581F81A153</div>
                </div>
                
                <div class="compatibility-warning" id="compatibilityWarning">
                    <h3><i class="fas fa-exclamation-triangle"></i> 兼容性提示</h3>
                    <p>本工具需要支持Web Bluetooth的浏览器（Chrome/Edge）</p>
                    <p>在本地运行时，请使用Chrome浏览器直接打开文件</p>
                    <p>在线部署需使用HTTPS（GitHub Pages自动支持）</p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>基于Web Bluetooth API的OTA升级工具 | 兼容ESP32和其他BLE设备</p>
            <p>通过特征UUID <strong>F7BF3564-FB6D-4E53-88A4-5E37E0326063</strong>发送控制命令 | 数据特征UUID <strong>984227F3-34FC-4045-A5D0-2C581F81A153</strong></p>
        </footer>
    </div>

    <script>
        // 定义UUID
        const OTA_SERVICE_UUID = '1d14d6ee-fd63-4fa1-bfa4-8f47b42119f0';
        const OTA_CONTROL_CHAR_UUID = 'f7bf3564-fb6d-4e53-88a4-5e37e0326063';
        const OTA_DATA_CHAR_UUID = '984227f3-34fc-4045-a5d0-2c581f81a153';

        // DOM元素
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const firmwareFile = document.getElementById('firmwareFile');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusBox = document.getElementById('statusBox');
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionStatusText = document.getElementById('connectionStatusText');
        const compatibilityWarning = document.getElementById('compatibilityWarning');

        // 状态变量
        let device = null;
        let otaService = null;
        let otaControlCharacteristic = null;
        let otaDataCharacteristic = null;
        let file = null;
        let isConnected = false;
        let isTransferring = false;
        let abortTransfer = false;

        // 初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 检查浏览器兼容性
            checkCompatibility();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 初始状态
            updateConnectionStatus();
            showStatus('准备就绪，请连接设备并选择固件文件', 'info');
        });

        // 检查浏览器兼容性
        function checkCompatibility() {
            if (!navigator.bluetooth) {
                showStatus('错误：您的浏览器不支持Web Bluetooth API', 'error');
                showStatus('请使用Chrome或Edge浏览器访问此页面', 'warning');
                
                // 禁用所有按钮
                connectBtn.disabled = true;
                disconnectBtn.disabled = true;
                startBtn.disabled = true;
                stopBtn.disabled = true;
                
                compatibilityWarning.innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle"></i> 浏览器不兼容</h3>
                    <p>您的浏览器不支持Web Bluetooth API</p>
                    <p>请使用以下浏览器：</p>
                    <ul style="text-align: left; margin: 10px 20px;">
                        <li>Chrome 56+ (桌面版)</li>
                        <li>Chrome 70+ (Android)</li>
                        <li>Edge 79+ (桌面版)</li>
                    </ul>
                    <p>本地运行：请使用Chrome浏览器直接打开HTML文件</p>
                    <p>在线部署：GitHub Pages自动提供HTTPS环境</p>
                `;
            } else {
                showStatus('浏览器支持Web Bluetooth API', 'success');
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 连接设备
            connectBtn.addEventListener('click', connectToDevice);
            
            // 断开连接
            disconnectBtn.addEventListener('click', disconnectDevice);
            
            // 开始升级
            startBtn.addEventListener('click', startOTA);
            
            // 停止升级
            stopBtn.addEventListener('click', stopOTA);
            
            // 文件选择
            fileInput.addEventListener('click', () => firmwareFile.click());
            firmwareFile.addEventListener('change', handleFileSelect);
        }

        // 连接蓝牙设备
        async function connectToDevice() {
            try {
                showStatus('正在扫描设备...', 'info');
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [OTA_SERVICE_UUID] }],
                    optionalServices: [OTA_SERVICE_UUID]
                });
                
                showStatus(`找到设备: ${device.name || '未知设备'}`, 'success');
                showStatus('连接中...', 'info');
                
                const server = await device.gatt.connect();
                isConnected = true;
                updateConnectionStatus();
                
                showStatus('已连接，正在获取服务...', 'info');
                otaService = await server.getPrimaryService(OTA_SERVICE_UUID);
                
                showStatus('获取服务成功，正在获取特征...', 'info');
                otaControlCharacteristic = await otaService.getCharacteristic(OTA_CONTROL_CHAR_UUID);
                otaDataCharacteristic = await otaService.getCharacteristic(OTA_DATA_CHAR_UUID);
                
                showStatus('特征获取成功，准备升级', 'success');
                startBtn.disabled = !file;
                disconnectBtn.disabled = false;
            } catch (error) {
                showStatus(`连接失败: ${error}`, 'error');
                console.error('连接错误:', error);
            }
        }

        // 断开设备连接
        function disconnectDevice() {
            if (device && device.gatt.connected) {
                try {
                    device.gatt.disconnect();
                    isConnected = false;
                    updateConnectionStatus();
                    showStatus('设备已断开', 'info');
                    disconnectBtn.disabled = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                    
                    // 重置状态
                    device = null;
                    otaService = null;
                    otaControlCharacteristic = null;
                    otaDataCharacteristic = null;
                } catch (error) {
                    showStatus(`断开连接错误: ${error}`, 'error');
                }
            }
        }

        // 处理文件选择
        function handleFileSelect(e) {
            file = e.target.files[0];
            if (file) {
                fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
                showStatus(`已选择固件文件: ${file.name}`, 'success');
                startBtn.disabled = !isConnected;
            } else {
                fileName.textContent = '未选择文件';
                startBtn.disabled = true;
            }
        }

        // 开始OTA升级
        async function startOTA() {
            if (!file) {
                showStatus('请先选择固件文件', 'error');
                return;
            }
            if (!isConnected || !otaControlCharacteristic || ! || otaDataCharacteristic) {
                showStatus('未连接到设备', 'error');
                return;
            }
            
            try {
                abortTransfer = false;
                isTransferring = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                showStatus('发送开始升级命令(0x00)...', 'info');
                await otaControlCharacteristic.writeValue(new Uint8Array([0x00]));
                showStatus('开始命令已发送', 'success');
                
                const reader = new FileReader();
                reader.onload = async function() {
                    const arrayBuffer = this.result;
                    const data = new Uint8Array(arrayBuffer);
                    const chunkSize = 20; // BLE MTU限制
                    const totalChunks = Math.ceil(data.length / chunkSize);
                    let transferred = 0;
                    
                    showStatus(`开始传输固件，共${totalChunks}个数据包...`, 'info');
                    updateProgress(0);
                    
                    for (let i = 0; i < totalChunks; i++) {
                        if (abortTransfer) {
                            showStatus('升级已中止', 'warning');
                            break;
                        }
                        
                        const start = i * chunkSize;
                        const end = Math.min(start + chunkSize, data.length);
                        const chunk = data.slice(start, end);
                        
                        // 发送数据包
                        await otaDataCharacteristic.writeValue(chunk);
                        
                        // 更新进度
                        transferred += chunk.length;
                        const progress = Math.round((transferred / data.length) * 100);
                        updateProgress(progress);
                        
                        // 每10%或每10个包更新状态
                        if (i % 10 === 0 || i === totalChunks - 1) {
                            showStatus(`发送包 ${i+1}/${totalChunks} (${progress}%)`, 'info');
                        }
                    }
                    
                    if (!abortTransfer) {
                        showStatus('固件传输完成，发送结束命令(0x03)...', 'info');
                        await otaControlCharacteristic.writeValue(new Uint8Array([0x03]));
                        showStatus('升级结束命令已发送，OTA升级完成！', 'success');
                        showStatus('设备将重启并应用新固件', 'info');
                    }
                    
                    }
                    
                    // 重置状态
                    isTransferring = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    abortTransfer = false;
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                showStatus(`升级失败: ${error}`, 'error');
                console.error('OTA错误:', error);
                isTransferring = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                disconnectBtn.disabled = false;
            }
        }

        // 停止OTA升级
        function stopOTA() {
            if (isTransferring) {
                abortTransfer = true;
                showStatus('正在停止传输...', 'warning');
            }
        }

        // 更新连接状态
        function updateConnectionStatus() {
            if (isConnected) {
                statusIndicator.className = 'status-indicator connected';
                connectionStatusText.textContent = '已连接';
                connectionStatusText.style.color = '#2ecc71';
            } else {
                statusIndicator.className = 'status-indicator';
                connectionStatusText.textContent = '未连接';
                connectionStatusText.style.color = '#e74c3c';
            }
        }

        // 更新进度
        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${percent}%`;
            progressText.textContent = `${percent}%`;
        }

        // 显示状态信息
        function showStatus(message, type = 'info') {
            const statusItem = document.createElement('div');
            statusItem.className = `status-item ${type}`;
            
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-times-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            
            statusItem.innerHTML = `<i class="${iconClass}"></i> ${message}`;
            statusBox.insertBefore(statusItem, statusBox.firstChild);
            
            // 限制最多显示50条状态
            if (statusBox.children.length > 50) {
                statusBox.removeChild(statusBox.lastChild);
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
